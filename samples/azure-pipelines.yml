trigger:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

# ============================================================
# VARIABLES — hover over any $(varName) reference in this file
# to see the variable's value and source line.
# ============================================================
variables:
  buildConfiguration: 'Release'
  dotnetVersion: '8.0.x'
  artifactName: 'drop'
  # Try hovering over $(buildConfiguration) or $(dotnetVersion) anywhere below!

stages:
  # ============================================================
  # BUILD STAGE
  # ============================================================
  - stage: Build
    displayName: 'Build & Test'
    jobs:
      - job: BuildJob
        displayName: 'Build .NET Application'
        steps:
          # Hover over the template line to see its parameters.
          # The extension will also warn you if you pass an unknown parameter
          # or forget a required one.
          - template: templates/build-dotnet.yml
            parameters:
              project: '**/*.csproj'
              buildConfiguration: $(buildConfiguration)   # ← hover over $(buildConfiguration)
              dotnetVersion: $(dotnetVersion)             # ← hover over $(dotnetVersion)
              publishArtifact: true
              artifactName: $(artifactName)               # ← hover over $(artifactName)

          # Relative path - run tests template
          - template: templates/run-tests.yml
            parameters:
              testProject: '**/*Tests.csproj'
              buildConfiguration: $(buildConfiguration)
              collectCoverage: true

      - job: DockerJob
        displayName: 'Build Docker Image'
        dependsOn: BuildJob
        steps:
          # Relative path - docker build template
          - template: templates/docker-build-push.yml
            parameters:
              repository: 'myapp/backend-api'
              dockerRegistryServiceConnection: 'DockerHub-Connection'
              dockerfile: 'src/Api/Dockerfile'
              pushImage: true

  # ============================================================
  # DEPLOY TO DEV
  # Absolute path from workspace root - references stages/ folder
  # ============================================================
  - template: /samples/stages/deploy-stage.yml
    parameters:
      environment: 'Development'
      azureSubscription: 'Azure-Dev-ServiceConnection'
      appName: 'myapp-dev-webapp'
      dependsOn:
        - Build

  # ============================================================
  # DEPLOY TO STAGING
  # ============================================================
  - template: /samples/stages/deploy-stage.yml
    parameters:
      environment: 'Staging'
      azureSubscription: 'Azure-Staging-ServiceConnection'
      appName: 'myapp-staging-webapp'
      dependsOn:
        - Deploy_Development
      condition: succeeded()

  # ============================================================
  # DEPLOY TO PRODUCTION
  # ============================================================
  - stage: DeployProduction
    displayName: 'Deploy to Production'
    dependsOn:
      - Deploy_Staging
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployProd
        displayName: 'Deploy to Production'
        environment: 'Production'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                # Relative path - deploy web app template
                - template: templates/deploy-webapp.yml
                  parameters:
                    environment: 'Production'
                    azureSubscription: 'Azure-Prod-ServiceConnection'
                    appName: 'myapp-prod-webapp'
                    slot: 'staging'
                    appType: 'webAppLinux'

                # Notify on completion
                - template: templates/notify-teams.yml
                  parameters:
                    #message: 'Deployment to Production complete!'
                    environment: 'Production'
                    includeRunLink: asd
